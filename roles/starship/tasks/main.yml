- name: Install Starship config
  copy:
    dest: "{{ HOME }}/.config/starship.toml"
    owner: "{{ USER }}"
    group: "{{ USER }}"
    mode: u=rw,go=r
    content: |
      "$schema" = 'https://starship.rs/config-schema.json'

      add_newline = false

      # Moved directory to second last (from default order)
      format = """
      $username\
      $hostname\
      $localip\
      $shlvl\
      $singularity\
      $kubernetes\
      $vcsh\
      $git_branch\
      $git_commit\
      $git_state\
      $git_metrics\
      $git_status\
      $hg_branch\
      $docker_context\
      $package\
      $buf\
      $c\
      $cmake\
      $cobol\
      $container\
      $dart\
      $deno\
      $dotnet\
      $elixir\
      $elm\
      $erlang\
      $golang\
      $haskell\
      $helm\
      $java\
      $julia\
      $kotlin\
      $lua\
      $nim\
      $nodejs\
      $ocaml\
      $perl\
      $php\
      $pulumi\
      $purescript\
      $python\
      $rlang\
      $red\
      $ruby\
      $rust\
      $scala\
      $swift\
      $terraform\
      $vlang\
      $vagrant\
      $zig\
      $nix_shell\
      $conda\
      $spack\
      $memory_usage\
      $aws\
      $gcloud\
      $openstack\
      $azure\
      $env_var\
      $crystal\
      $custom\
      $cmd_duration\
      $line_break\
      $jobs\
      $battery\
      $time\
      $status\
      $shell\
      $directory\
      $sudo\
      $character"""

      [line_break]
      disabled = true

      [directory]
      format = "[$path]($style)[$read_only]($read_only_style)"
      [cmd_duration]
      format = "â±ï¸ [$duration]($style) "

      [gcloud.region_aliases]
      australia-southeast1 = "au"
      [aws.region_aliases]
      ap-southeast-2 = "au"

      [git_branch]
      symbol = "ğŸŒ±"
      format = "[$symbol$branch]($style) "
      [git_state]
      cherry_pick = "ğŸ’"
      [docker_context]
      symbol = "ğŸ‹"
      format = "[$symbol$context]($style) "
      [package]
      symbol = "ğŸ“¦"
      format = "[$symbol$version]($style) "

      [gcloud]
      symbol = "ğŸ‡¬ï¸ "
      format = '[$symbol$active(\($region\))]($style) '
      [aws]
      symbol = "â˜ï¸ "
      format = '[$symbol$profile(\($region\))]($style) '

      [python]
      symbol = "ğŸ"
      format = '[${symbol}${pyenv_prefix}${version}( \($virtualenv\))]($style) '
      [rust]
      symbol = "ğŸ¦€"
      format = "[$symbol$version]($style) "
      [golang]
      symbol = "ğŸ¹"
      format = "[$symbol$version]($style) "
      [terraform]
      symbol = "ğŸ’ "
      format = "[$symbol$workspace]($style) "

      [memory_usage]
      disabled = false
      symbol = "ğŸ"
      format = "$symbol [${ram_pct}]($style) "

      [sudo]
      disabled = false
      symbol = "ğŸ§™"
      format = "[$symbol]($style)"

- name: Setup Starship Terminal Prompt
  blockinfile:
    path: "{{ HOME }}/.bashrc"
    insertafter: "# END Rust"
    marker: "# {mark} Starship"
    block: |
      eval "$(starship init bash)"
      function _pre_starship_prompt_commands {
        local STATUS=$?  # Passthrough the last exit code for starship
        history -a
        __vte_prompt_command
        return $STATUS
      }
      PROMPT_COMMAND="_pre_starship_prompt_commands;starship_precmd"
