#!/usr/bin/python3
import re

from ansible.module_utils.basic import AnsibleModule


PACKAGE_PATTERN = re.compile(r"^(\S+)", re.MULTILINE)


def get_installed_packages(run, bin_path):
    _, stdout, _ = run([bin_path, "install", "--list"])
    return set(i.lower() for i in PACKAGE_PATTERN.findall(stdout))


def install_packages(run, bin_path, packages):
    return run([bin_path, "install", "--locked"] + packages, check_rc=True)


def main():
    module_args = dict(
        name=dict(type="list", required=True),
    )

    r = {"changed": False}
    module = AnsibleModule(argument_spec=module_args, supports_check_mode=True)
    bin_path = "~/.cargo/bin/cargo"

    to_install = {i.lower() for i in module.params["name"]}
    installed = get_installed_packages(module.run_command, bin_path)

    missing = sorted(to_install - installed)
    if missing:
        r["changed"] = True
        if not module.check_mode:
            r["rc"], r["stdout"], r["stderr"] = install_packages(module.run_command, bin_path, missing)
        else:
            r["diff"] = {
                "before": "\n".join(sorted(installed & to_install)),
                "after": "\n".join(sorted(to_install)),
            }
    module.exit_json(**r)


if __name__ == "__main__":
    main()
